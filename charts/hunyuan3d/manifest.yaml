apiVersion: v1
kind: Namespace
metadata:
  name: hunyuan3d
  labels:
    name: hunyuan3d
    app: 3d-generation
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: storage
  namespace: hunyuan3d
  labels:
    app: hunyuan3d
    component: storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hunyuan3d
  namespace: hunyuan3d
  labels:
    app: hunyuan3d
spec:
  replicas: 1
  strategy:
    type: Recreate # Use Recreate for GPU workloads
  selector:
    matchLabels:
      app: hunyuan3d
  template:
    metadata:
      labels:
        app: hunyuan3d
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "7860"
    spec:
      # Service account (use default or create specific one)
      serviceAccountName: default

      # Security context for pod
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      containers:
        - name: hunyuan3d
          image: hunyuan3d:latest # Update with your registry/image
          imagePullPolicy: IfNotPresent
          args:
            [
              "python",
              "gradio_app.py",
              "--port",
              "7860",
              "--cache-path",
              "/cache",
              "--model_path",
              "tencent/Hunyuan3D-2.1",
              "--subfolder",
              "hunyuan3d-dit-v2-1",
              "--texgen_model_path",
              "tencent/Hunyuan3D-2.1",
              "--disable_tex",
              "--low_vram_mode",
            ]

          # Resource requests and limits
          resources:
            requests:
              memory: "16Gi"
              cpu: "4"
              nvidia.com/gpu: 1
            limits:
              nvidia.com/gpu: 1

          # Environment variables from Secret
          env:
            - name: HF_HOME
              value: /storage/hf_home
            - name: MPLCONFIGDIR
              value: /storage/matplotlib
            - name: NUMBA_CACHE_DIR
              value: /cache/numba
            - name: U2NET_HOME
              value: /storage/u2net
            - name: HY3DGEN_MODELS
              value: /storage/hy3dgen
            - name: HF_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hf-token
                  key: token

          # Ports
          ports:
            - containerPort: 7860
              name: gradio
              protocol: TCP

          # Volume mounts
          volumeMounts:
            - name: storage
              mountPath: /storage
              subPath: storage
            - name: storage
              mountPath: /cache
              subPath: cache
            - name: tmp
              mountPath: /tmp

          # Startup probe (for initial model download)
          startupProbe:
            httpGet:
              path: /
              port: 7860
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30 # 5 minutes max startup time

          # Liveness probe
          livenessProbe:
            httpGet:
              path: /
              port: 7860
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          # Readiness probe
          readinessProbe:
            httpGet:
              path: /
              port: 7860
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault

      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: storage
        - name: tmp
          emptyDir: {}
---
# Service
apiVersion: v1
kind: Service
metadata:
  name: hunyuan3d
  namespace: hunyuan3d
  labels:
    app: hunyuan3d
spec:
  type: ClusterIP
  selector:
    app: hunyuan3d
  ports:
    - port: 80
      targetPort: 7860
      protocol: TCP
      name: http
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800 # 3 hours for long-running sessions
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  annotations:
    gethomepage.dev/enabled: "true"
    gethomepage.dev/group: Homelab
    gethomepage.dev/icon: si-open3d
    gethomepage.dev/name: Hunyuan3D
  name: hunyuan3d
spec:
  hostnames:
    - hunyuan3d.int.imdevinc.com
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: traefik-gateway
      namespace: traefik
  rules:
    - backendRefs:
        - group: ""
          kind: Service
          name: hunyuan3d
          namespace: hunyuan3d
          port: 80
          weight: 1
      matches:
        - path:
            type: PathPrefix
            value: /
