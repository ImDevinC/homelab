apiVersion: v1
kind: Namespace
metadata:
  name: hunyuan3d
  labels:
    name: hunyuan3d
    app: 3d-generation
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: storage
  namespace: hunyuan3d
  labels:
    app: hunyuan3d
    component: storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
---
# ConfigMap for application configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: hunyuan3d-config
  namespace: hunyuan3d
  labels:
    app: hunyuan3d
data:
  MODEL_PATH: "tencent/Hunyuan3D-2"
  SUBFOLDER: "hunyuan3d-dit-v2-0"
  TEXGEN_MODEL_PATH: "tencent/Hunyuan3D-2"
  LOW_VRAM_MODE: "false"
  ENABLE_FLASHVDM: "false"
  GRADIO_PORT: "7860"
  HOST: "0.0.0.0"
---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hunyuan3d
  namespace: hunyuan3d
  labels:
    app: hunyuan3d
spec:
  replicas: 1
  strategy:
    type: Recreate  # Use Recreate for GPU workloads
  selector:
    matchLabels:
      app: hunyuan3d
  template:
    metadata:
      labels:
        app: hunyuan3d
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "7860"
    spec:
      # Node selection for GPU nodes
      nodeSelector:
        nvidia.com/gpu.present: "true"
      
      # Tolerations for GPU nodes (if using taints)
      tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
      
      # Service account (use default or create specific one)
      serviceAccountName: default
      
      # Security context for pod
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      
      # Init container to set up directories
      initContainers:
      - name: setup
        image: busybox:1.36
        command: ['sh', '-c', 'mkdir -p /cache/huggingface /cache/torch && chown -R 1000:1000 /cache']
        volumeMounts:
        - name: cache
          mountPath: /cache
        securityContext:
          runAsUser: 0
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
            add:
            - CHOWN
      
      containers:
      - name: hunyuan3d
        image: hunyuan3d:latest  # Update with your registry/image
        imagePullPolicy: IfNotPresent
        
        # Command override if needed
        # args: ["gradio"]
        
        # Resource requests and limits
        resources:
          requests:
            memory: "16Gi"
            cpu: "4"
            nvidia.com/gpu: 1
          limits:
            memory: "32Gi"
            cpu: "8"
            nvidia.com/gpu: 1
        
        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: hunyuan3d-config
        
        # Environment variables from Secret
        env:
        - name: HF_TOKEN
          valueFrom:
            secretKeyRef:
              name: hf-token
              key: token
              optional: true
        
        # Ports
        ports:
        - containerPort: 7860
          name: gradio
          protocol: TCP
        
        # Volume mounts
        volumeMounts:
        - name: storage
          mountPath: /models
          subPath: models
        - name: storage
          mountPath: /cache
          subPath: cache
        - name: tmp
          mountPath: /tmp
        
        # Startup probe (for initial model download)
        startupProbe:
          httpGet:
            path: /
            port: 7860
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 30  # 5 minutes max startup time
        
        # Liveness probe
        livenessProbe:
          httpGet:
            path: /
            port: 7860
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        
        # Readiness probe
        readinessProbe:
          httpGet:
            path: /
            port: 7860
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        # Security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
      
      volumes:
      - name: storage
        persistentVolumeClaim:
          claimName: storage
      - name: tmp
        emptyDir: {}
---
# Service
apiVersion: v1
kind: Service
metadata:
  name: hunyuan3d
  namespace: hunyuan3d
  labels:
    app: hunyuan3d
spec:
  type: ClusterIP
  selector:
    app: hunyuan3d
  ports:
  - port: 80
    targetPort: 7860
    protocol: TCP
    name: http
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800  # 3 hours for long-running sessions
